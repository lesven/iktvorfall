// Fragebogen-Konfiguration
const questions = [    {
        id: 1,
        title: "Betrifft der Vorfall IKT-Systeme?",
        text: "Ist ein Computer-System (Server, Netzwerk, Software, etc.) betroffen?",        additionalInfo: `
        <strong>üîß Was sind IKT-Systeme?</strong><br>
        Alle Computer-Systeme in deinem Unternehmen:<br><br>
        
        ‚Ä¢ Server, Computer, Handys<br>
        ‚Ä¢ Banking-Programme, Windows, Apps<br>
        ‚Ä¢ Internet, WLAN, Firmen-Netzwerk<br>
        ‚Ä¢ Microsoft 365, Google Drive, Cloud-Services<br><br>
        
        <strong>‚ö†Ô∏è Auch das z√§hlt:</strong><br>
        ‚Ä¢ Stromausfall, Wasserschaden<br>
        ‚Ä¢ Nur ein Teil des Systems kaputt<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Online-Banking funktioniert nicht<br>
        ‚úÖ E-Mail geht nicht<br>
        ‚úÖ Handy-App st√ºrzt ab<br>
        ‚úÖ Server f√§llt aus
        `
    },    {
        id: 2,
        title: "Sind kritische oder wichtige Gesch√§ftsfunktionen betroffen?",
        text: "St√∂rt der Vorfall wichtige Arbeitsabl√§ufe in deinem Unternehmen?",
        additionalInfo: `
        <strong>üè¶ Wichtige Gesch√§ftsfunktionen:</strong><br>
        ‚Ä¢ Online-Banking und Banking-Apps<br>
        ‚Ä¢ √úberweisungen und Kartenzahlungen<br>
        ‚Ä¢ Kredite und Kontoverwaltung<br>
        ‚Ä¢ B√∂rsenhandel<br>
        ‚Ä¢ E-Mail und wichtige IT-Systeme<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Online-Banking l√§nger als 1h offline<br>
        ‚úÖ Kreditkarten werden abgelehnt<br>
        ‚úÖ Geldautomaten ausgefallen<br>
        ‚úÖ E-Mail funktioniert nicht<br>
        ‚ùå Interne Schulungs-Plattform offline
        `    },{
        id: 3,        title: "Entspricht der Vorfall zeitlichen Kriterien?",
        text: "Dauert die St√∂rung schon l√§nger als 1 Stunde?",
        additionalInfo: `
        <strong>‚è∞ Wichtige Zeitgrenzen:</strong><br><br>
        
        <strong>Wesentliche St√∂rung (DORA):</strong><br>
        ‚Ä¢ √úber 1 Stunde ohne Service bei kritischen Funktionen<br>
        ‚Ä¢ √úber 2 Stunden bei wichtigen Funktionen<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Online-Banking seit 1,5h offline<br>
        ‚úÖ Kartenzahlungen seit 3h gest√∂rt<br>
        ‚úÖ Geldautomaten-Netz seit 2h ausgefallen<br>
        ‚ùå E-Mail war 45 Min offline<br>
        ‚ùå Website 30 Min langsam
        `
    },    {
        id: 4,        title: "Sind personenbezogene oder sensible Daten betroffen?",
        text: "K√∂nnten pers√∂nliche Daten oder Gesch√§ftsgeheimnisse betroffen sein?",
        additionalInfo: `
        <strong>üîí Kritische Daten:</strong><br><br>
        
        <strong>Kundendaten:</strong><br>
        ‚Ä¢ Namen, Adressen, Geburtsdaten<br>
        ‚Ä¢ Kontost√§nde, √úberweisungen<br>
        ‚Ä¢ Logins, PINs, Passw√∂rter<br><br>
        
        <strong>Gesch√§ftsdaten:</strong><br>
        ‚Ä¢ Vertr√§ge und Gesch√§ftsgeheimnisse<br>
        ‚Ä¢ E-Mails und Mitarbeiterdaten<br>
        ‚Ä¢ System-Zugangsdaten<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Hacker-Zugriff auf Kundendatenbank<br>
        ‚úÖ USB-Stick mit Kontodaten verloren<br>
        ‚úÖ E-Mail an falschen Empf√§nger<br>
        ‚úÖ Ransomware verschl√ºsselt Dateien<br>
        ‚ùå Test-System ohne echte Daten
        `
    },    {
        id: 5,        title: "Sind externe IKT-Dienstleister oder Partner betroffen?",
        text: "Hat der Vorfall mit Cloud-Services oder IT-Dienstleistern zu tun?",
        additionalInfo: `
        <strong>‚òÅÔ∏è Externe IT-Services:</strong><br><br>
        
        <strong>Cloud-Anbieter:</strong><br>
        ‚Ä¢ Microsoft 365, Google Cloud<br>
        ‚Ä¢ AWS, Azure Services<br>
        ‚Ä¢ Backup- und Speicher-Services<br><br>
        
        <strong>Banking-Services:</strong><br>
        ‚Ä¢ Zahlungsdienstleister<br>
        ‚Ä¢ B√∂rsen-Anbindungen<br>
        ‚Ä¢ Kernbanksysteme<br>
        ‚Ä¢ Internet-Provider<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Microsoft 365 down ‚Üí E-Mail gest√∂rt<br>
        ‚úÖ AWS-Ausfall ‚Üí Banking-App offline<br>
        ‚úÖ Kreditkarten-Dienstleister gest√∂rt<br>
        ‚úÖ Internet-Provider-St√∂rung<br>
        ‚ùå Interne Kantine-Software
        `
    },    {
        id: 6,        title: "Besteht Verdacht auf Cyberangriff oder b√∂swillige Aktivit√§ten?",
        text: "Siehst du Anzeichen f√ºr einen m√∂glichen Cyberangriff?",
        additionalInfo: `
        <strong>‚ö†Ô∏è Verdachtsmomente:</strong><br><br>
        
        <strong>Technische Anzeichen:</strong><br>
        ‚Ä¢ Ungew√∂hnliche Netzwerk-Aktivit√§ten<br>
        ‚Ä¢ Neue unbekannte Dateien oder Programme<br>
        ‚Ä¢ Verschl√ºsselte oder ver√§nderte Dateien<br>
        ‚Ä¢ Langsame Systeme ohne erkennbaren Grund<br><br>
        
        <strong>Angriffs-Arten:</strong><br>
        ‚Ä¢ Phishing-E-Mails oder betr√ºgerische Anrufe<br>
        ‚Ä¢ Ransomware (L√∂segeldforderung)<br>
        ‚Ä¢ DDoS-Angriffe (Website √ºberlastet)<br>
        ‚Ä¢ Unberechtigte Logins oder Zugriffe<br><br>
        
        <strong>üí° Beispiele:</strong><br>
        ‚úÖ Ransomware verschl√ºsselt Dateien<br>
        ‚úÖ Phishing-E-Mail f√ºhrt zu Datenverlust<br>
        ‚úÖ Unbekannte Logins von fremden Standorten<br>
        ‚úÖ DDoS macht Website unzug√§nglich<br>
        ‚ùå Zuf√§lliger Hardware-Defekt
        `
    },
];

// Anwendungszustand
let currentQuestionIndex = 0;
let answers = [];
let isQuestionnaireStarted = false;

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    showScreen('welcome-screen');
    setupEmailClickTracking();
});

// Screen-Management
function showScreen(screenId) {
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => screen.classList.remove('active'));
    
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
        targetScreen.classList.add('active');
    }
}

// Fragebogen starten
function startQuestionnaire() {
    currentQuestionIndex = 0;
    answers = [];
    isQuestionnaireStarted = true;
    showQuestion();
    showScreen('question-screen');
}

// Frage anzeigen
function showQuestion() {
    if (currentQuestionIndex >= questions.length) {
        showResult();
        return;
    }

    const question = questions[currentQuestionIndex];
    const progressPercent = ((currentQuestionIndex + 1) / questions.length) * 100;
    
    // Progress Bar aktualisieren
    document.getElementById('progress-fill').style.width = progressPercent + '%';
    document.getElementById('progress-text').textContent = `Frage ${currentQuestionIndex + 1} von ${questions.length}`;
    
    // Frage-Inhalt aktualisieren
    document.getElementById('question-title').textContent = question.title;
    document.getElementById('question-text').textContent = question.text;
    
    // Zus√§tzliche Informationen
    const additionalInfo = document.getElementById('additional-info');
    if (question.additionalInfo) {
        additionalInfo.innerHTML = `<strong>üí° Zus√§tzliche Information:</strong><br>${question.additionalInfo}`;
        additionalInfo.style.display = 'block';
    } else {
        additionalInfo.style.display = 'none';
    }
    
    // Zur√ºck-Button Status
    const backBtn = document.getElementById('back-btn');
    backBtn.disabled = currentQuestionIndex === 0;
}

// Antwort verarbeiten
function answerQuestion(answer) {
    answers[currentQuestionIndex] = answer;
    currentQuestionIndex++;
    
    if (currentQuestionIndex < questions.length) {
        showQuestion();
    } else {
        showResult();
    }
}

// Zur√ºck-Navigation
function goBack() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion();
    }
}

// Ergebnis berechnen und anzeigen
function showResult() {
    const resultContent = document.getElementById('result-content');
    const shouldReport = calculateResult();
    
    if (shouldReport) {
        resultContent.innerHTML = `
            <div class="result-danger">
                <h3>‚ö†Ô∏è Meldepflichtiger Vorfall erkannt</h3>
                <p><strong>Bitte informieren Sie Nikolas √ºber diesen Vorfall.</strong></p>
                <p>Basierend auf Ihren Antworten handelt es sich m√∂glicherweise um einen meldepflichtigen IKT-Vorfall nach DORA.</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showContact()">üìû Nikolas kontaktieren</button>
                </div>
            </div>
        `;
    } else {
        resultContent.innerHTML = `
            <div class="result-success">
                <h3>‚úÖ Kein meldepflichtiger Vorfall</h3>
                <p><strong>Bitte dokumentieren Sie den Vorfall intern.</strong></p>
                <p>Basierend auf Ihren Antworten ist keine sofortige Meldung nach DORA erforderlich. Dokumentieren Sie den Vorfall dennoch f√ºr interne Zwecke.</p>
                <div class="additional-info" style="margin-top: 20px; text-align: left;">
                    <strong>üìã Empfohlene Ma√ünahmen:</strong><br>
                    ‚Ä¢ Vorfall in internem System dokumentieren<br>
                    ‚Ä¢ Ursachen analysieren<br>
                    ‚Ä¢ Pr√§ventive Ma√ünahmen pr√ºfen<br>
                    ‚Ä¢ Bei Unsicherheit: IT-Abteilung kontaktieren
                </div>
            </div>
        `;
    }
    
    showScreen('result-screen');
}

// Ergebnis-Logik
function calculateResult() {
    // Wenn eine der kritischen Fragen mit "Ja" beantwortet wurde
    const criticalQuestions = [0, 3, 5]; // IKT-Systeme, Personendaten, Cyberangriff
    const moderateQuestions = [1, 2, 4]; // Gesch√§ftsprozesse, Dauer, Externe Systeme
    
    // Kritische Fragen
    let criticalYes = 0;
    criticalQuestions.forEach(index => {
        if (answers[index] === true) criticalYes++;
    });
    
    // Moderate Fragen
    let moderateYes = 0;
    moderateQuestions.forEach(index => {
        if (answers[index] === true) moderateYes++;
    });
    
    // Bewertungslogik
    if (criticalYes >= 2) return true; // Zwei kritische Faktoren
    if (criticalYes >= 1 && moderateYes >= 2) return true; // Ein kritischer + zwei moderate
    if (answers[3] === true) return true; // Personendaten immer melden
    if (answers[5] === true) return true; // Cyberangriff immer melden
    
    return false;
}

// Kontakt-Screen anzeigen
function showContact() {
    showScreen('contact-screen');
}

// Fragebogen zur√ºcksetzen
function resetQuestionnaire() {
    currentQuestionIndex = 0;
    answers = [];
    isQuestionnaireStarted = false;
    showScreen('welcome-screen');
    
    // Progress Bar zur√ºcksetzen
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('progress-text').textContent = 'Frage 1 von 6';
    
    // Erfolgsmeldung verstecken
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.style.display = 'none';
    }
}

// E-Mail-Klick-Tracking f√ºr Erfolgsmeldung
function setupEmailClickTracking() {
    document.addEventListener('click', function(event) {
        if (event.target.matches('a[href^="mailto:"]')) {
            // Kurze Verz√∂gerung, damit E-Mail-Client √∂ffnen kann
            setTimeout(() => {
                const successMessage = document.getElementById('success-message');
                if (successMessage) {
                    successMessage.style.display = 'block';
                    successMessage.scrollIntoView({ behavior: 'smooth' });
                }
            }, 1000);
        }
    });
}

// Tastatur-Navigation
document.addEventListener('keydown', function(event) {
    if (!isQuestionnaireStarted) return;
    
    switch(event.key) {
        case 'y':
        case 'Y':
        case 'j':
        case 'J':
            if (document.getElementById('question-screen').classList.contains('active')) {
                answerQuestion(true);
            }
            break;
        case 'n':
        case 'N':
            if (document.getElementById('question-screen').classList.contains('active')) {
                answerQuestion(false);
            }
            break;
        case 'Escape':
            resetQuestionnaire();
            break;
        case 'Backspace':
            if (document.getElementById('question-screen').classList.contains('active')) {
                goBack();
            }
            break;
    }
});

// Accessibility: Focus-Management
function manageFocus() {
    const activeScreen = document.querySelector('.screen.active');
    if (activeScreen) {
        const firstButton = activeScreen.querySelector('button:not(:disabled)');
        if (firstButton) {
            firstButton.focus();
        }
    }
}

// Focus nach Screen-Wechsel setzen
const originalShowScreen = showScreen;
showScreen = function(screenId) {
    originalShowScreen(screenId);
    setTimeout(manageFocus, 100);
};

// Debugging-Funktionen (k√∂nnen in Produktion entfernt werden)
function getDebugInfo() {
    return {
        currentQuestion: currentQuestionIndex + 1,
        answers: answers,
        isStarted: isQuestionnaireStarted,
        result: isQuestionnaireStarted && currentQuestionIndex >= questions.length ? calculateResult() : null
    };
}

// Export f√ºr m√∂gliche Tests
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        questions,
        calculateResult,
        getDebugInfo
    };
}
